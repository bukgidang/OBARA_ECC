<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>E.C.C CACULATOR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial,sans-serif; margin:22px; max-width:740px; margin-left:auto; margin-right:auto;}
    label { display: block; margin-top: 12px; font-weight: bold; }
    input[type="number"], select {
      width: 100%; max-width:320px; box-sizing: border-box;
      font-size: 1.11em; margin-top:4px; margin-bottom:2px;
      padding: 10px 8px; border-radius: 6px; border:1px solid #b9b9b9;
    }
    .button-group {
      margin-top: 22px; display: flex; flex-wrap: wrap; gap: 10px;
    }
    .button-group button {
      flex: 1 1 160px; min-width: 135px;
      padding: 12px 3px; font-size: 1.1em; font-weight: bold;
      background: #1a5be3; color: #fff; border: none; border-radius: 7px;
      box-shadow: 0 1px 4px #aaa3; margin-bottom: 8px; cursor: pointer; transition: background .2s;
    }
    .button-group button:hover { background: #256ce6;}
    .result { margin-top: 22px; font-size: 1.13em; color: #1457a7;
      white-space: pre-line; word-break: break-all; display: none; }
    #ecc-point { margin: 19px 0 10px 0; color: #c89300; font-weight: bold; font-size: 1.15em; word-break: break-all;}
    #chart-area {
      margin-top: 32px; width: 100%; min-width:0; position:relative;
      max-width: 100%; box-sizing: border-box;
      height: 440px;    /* 고정 높이! (PC/모바일 둘 다 충분) */
      min-height: 410px; max-height: 480px;
    }
    #eccChart {
      display: block;
      width: 100% !important;
      height: 420px !important;   /* ← 그래프 본체 크기 고정 */
      min-height: 410px !important;
      max-width: 100%;
      background-color: #fff;
      border-radius: 11px;
      box-shadow: 0 2px 10px #9992;
    }
    #okng-label {
      display: none; position: absolute; font-size: 1.50em; font-weight: bold;
      pointer-events: none; user-select: none; z-index: 10;
      text-shadow: 0 1.5px 4px #fff, 0 0 2px #000; letter-spacing:2px;
    }
    @media (max-width:700px) {
      html, body { font-size: 15.7px; }
      #chart-area{ height: 340px; min-height:270px; max-height:390px;}
      #eccChart { height: 320px !important; min-height: 260px !important;}
    }
    @media (max-width:480px) {
      #chart-area{ height: 230px; min-height:170px; max-height:260px;}
      #eccChart { height: 210px !important; min-height: 150px !important;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2 style="font-size:1.32em;">E.C.C CACULATOR</h2>
  <label>용접전류1 (A): <input type="number" id="current1" placeholder="예: 1200" autocomplete="off" /></label>
  <label>용접전류2 (A): <input type="number" id="current2" placeholder="예: 1100" autocomplete="off" /></label>
  <label>용접전류3 (A): <input type="number" id="current3" placeholder="예: 1300" autocomplete="off" /></label>
  <label>용접시간1 (ms): <input type="number" id="time1" placeholder="예: 150" autocomplete="off" /></label>
  <label>용접시간2 (ms): <input type="number" id="time2" placeholder="예: 200" autocomplete="off" /></label>
  <label>용접시간3 (ms): <input type="number" id="time3" placeholder="예: 180" autocomplete="off" /></label>
  <label>타점 수: <input type="number" id="count" placeholder="예: 10" autocomplete="off" /></label>
  <label>전체 시간 (ms): <input type="number" id="totalTime" value="60000" autocomplete="off" /></label>
  <div id="ecc-compare-area" style="margin-top:13px;">
    <label>TR E.C.C (A): <input type="number" id="trValue" value="5000" autocomplete="off" /></label>
    <label>DIODE E.C.C (A): <input type="number" id="diodeValue" value="7110" autocomplete="off" /></label>
    <label>DIODE 개수:
      <select id="diodeCount">
        <option value="2" selected>2</option>
        <option value="4">4</option>
        <option value="8">8</option>
      </select>
    </label>
  </div>
  <div class="button-group">
    <button type="button" onclick="calculateAndDraw()">계산 및 그래프</button>
    <button type="button" onclick="downloadTxt()">텍스트 파일로 저장</button>
  </div>
  <div class="result" id="result"></div>
  <div id="ecc-point"></div>
  <hr style="margin: 34px 0 18px 0; border:0; border-top:1.5px solid #bbb;" />

  <div id="chart-area">
    <canvas id="eccChart" width="750" height="420"></canvas>
    <div id="okng-label"></div>
  </div>
<script>
let chart = null, lastCalcResult = null, lastCalcParams = {}, lastSpecialPoint = null, lastECCJudge = null;
function calculate() {
  const current1 = Number(document.getElementById('current1').value);
  const current2 = Number(document.getElementById('current2').value);
  const current3 = Number(document.getElementById('current3').value);
  const time1 = Number(document.getElementById('time1').value);
  const time2 = Number(document.getElementById('time2').value);
  const time3 = Number(document.getElementById('time3').value);
  const count = Number(document.getElementById('count').value);
  const totalTime = Number(document.getElementById('totalTime').value);

  if(totalTime === 0){
    // 입력값 요약 화면 미노출
    lastCalcResult = null; lastCalcParams = {}; lastSpecialPoint = null; lastECCJudge = null;
    document.getElementById('ecc-point').innerText = '';
    document.getElementById('result').style.display = 'none';
    return;
  }
  const innerSum = (current1 ** 2) * time1 + (current2 ** 2) * time2 + (current3 ** 2) * time3;
  const value = Math.sqrt((count / totalTime) * innerSum);
  lastCalcResult = value;
  lastCalcParams = {current1, current2, current3, time1, time2, time3, count, totalTime};
  let specialStr = '';
  const xval_percent = totalTime > 0 ? ((time1 + time2 + time3) * count / totalTime) * 100 : null;
  let yval = null, trY = null, judgeMark = '', judgeColor = '';
  if(xval_percent && xval_percent > 0 && lastCalcResult) {
    yval = getCurrent(lastCalcResult, xval_percent);
    const tr = Number(document.getElementById("trValue").value) || 0;
    trY = getCurrent(tr, xval_percent);
    if(xval_percent >= 1 && xval_percent <= 100) {
      specialStr = `ECC 교차점: DUTY&nbsp;CYCLE&nbsp;=&nbsp;${xval_percent.toFixed(2)}%&nbsp;&nbsp;,&nbsp;&nbsp;CURRENT&nbsp;=&nbsp;${Math.round(yval).toLocaleString()}A`;
      if (yval > trY) { judgeMark = "NG"; judgeColor = "#e84c4c";}
      else           { judgeMark = "OK"; judgeColor = "#2ab45d";}
      lastECCJudge = { mark: judgeMark, color: judgeColor, x: xval_percent, y: yval };
    } else {
      specialStr = "ECC 교차점: (그래프 영역 [1~100%] 외)";
      lastECCJudge = null;
    }
    lastSpecialPoint = { x: xval_percent, y: yval };
  } else {
    lastSpecialPoint = null; lastECCJudge = null; specialStr = '';
  }
  document.getElementById('ecc-point').innerHTML = specialStr;
  document.getElementById('result').style.display = 'none';
}
function downloadTxt() {
  const current1 = document.getElementById('current1').value;
  const current2 = document.getElementById('current2').value;
  const current3 = document.getElementById('current3').value;
  const time1 = document.getElementById('time1').value;
  const time2 = document.getElementById('time2').value;
  const time3 = document.getElementById('time3').value;
  const count = document.getElementById('count').value;
  const totalTime = document.getElementById('totalTime').value;
  const innerSum = (current1 ** 2) * time1 + (current2 ** 2) * time2 + (current3 ** 2) * time3;
  const value = Math.sqrt((count / totalTime) * innerSum);
  // 입력값 요약/결과만 파일에 포함
  const text = `용접전류1: ${current1} A
용접전류2: ${current2} A
용접전류3: ${current3} A
용접시간1: ${time1} ms
용접시간2: ${time2} ms
용접시간3: ${time3} ms
타점 수: ${count}
전체 시간: ${totalTime} ms

ECC = √[ (타점 수 / 전체 시간) × (전류1²×시간1 + 전류2²×시간2 + 전류3²×시간3) ] = ${value.toFixed(3)} A
`;
  const blob = new Blob([text], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url; link.download = "weld_result.txt";
  document.body.appendChild(link); link.click();
  document.body.removeChild(link); URL.revokeObjectURL(url);
}
function getCurrent(tr, duty) { return tr * 10 / Math.sqrt(duty);}
function calculateAndDraw() { calculate(); drawCustomGraph(); }
function drawCustomGraph() {
  const tr = Number(document.getElementById("trValue").value);
  const diode = Number(document.getElementById("diodeValue").value);
  const diodeCnt = Number(document.getElementById("diodeCount").value);
  if (!tr || !diode || !diodeCnt) {
    alert("TR E.C.C, DIODE E.C.C, DIODE 개수 모두 입력해 주세요."); return;
  }
  const duty = [1,2,3,4,5,6,7,8,9,10,20,30,40,50,60,70,80,90,100];
  const trData = duty.map(d => getCurrent(tr, d));
  const diodeTotal = diode * diodeCnt;
  const diodeData = duty.map(d => getCurrent(diodeTotal, d));
  let calcData = null, calcInfo = "";
  if(lastCalcResult && !isNaN(lastCalcResult)) {
    calcData = duty.map(d => getCurrent(lastCalcResult, d));
    calcInfo = `, ECC(${lastCalcResult.toFixed(1)}A)`;
  }
  let specialPoint = null;
  if(lastSpecialPoint && lastSpecialPoint.x && lastSpecialPoint.y && lastSpecialPoint.x >= 1 && lastSpecialPoint.x <= 100) {
    specialPoint = lastSpecialPoint;
  }
  const ctx = document.getElementById("eccChart").getContext("2d");
  if(chart) chart.destroy();

  let datasets = [
    {
      label: `TR (${tr}A)`,
      data: trData, borderColor: "red", borderWidth:3, fill:false,
      tension: 0.2, borderDash:[8,8], pointRadius:0
    },
    {
      label: `DIODE${diodeCnt} (${diode}A × ${diodeCnt} = ${diodeTotal}A)`,
      data: diodeData, borderColor: "green", borderWidth:3, fill:false,
      tension: 0.2, borderDash:[8,8], pointRadius:0
    }
  ];
  if(calcData) {
    datasets.push({
      label:`ECC (${calcInfo})`,
      data: calcData, borderColor:"gold", borderWidth:3, fill:false,
      tension:0.2, borderDash:[], pointRadius:0
    });
  }
  if(specialPoint) {
    datasets.push({
      type:'scatter', label:'ECC교차점',
      data:[{x:specialPoint.x, y:specialPoint.y}],
      backgroundColor:'gold', pointRadius:6, showLine:false
    });
    datasets.push({
      type: 'line', label: '', data: [{x: specialPoint.x, y: specialPoint.y}, {x: specialPoint.x, y: 0}],
      borderColor: 'gold', borderWidth: 2, borderDash: [4,4], pointRadius: 0, fill: false, tension: 0
    });
    datasets.push({
      type: 'line', label: '', data: [{x: 1, y: specialPoint.y}, {x: specialPoint.x, y: specialPoint.y}],
      borderColor: 'gold', borderWidth: 2, borderDash: [4,4], pointRadius: 0, fill: false, tension: 0
    });
  }

  chart = new Chart(ctx, {
    type: "line",
    data: { labels: duty, datasets: datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: {
          display:true,
          position: 'right'  // ← 주석(범례) 오른쪽으로!
        },
        title: { display:true, text: "DUTY CYCLE (%)에 따른 CURRENT (A)"},
        tooltip: { enabled:true }
      },
      layout: { padding:{right:18,left:10,top:4,bottom:4} },
      scales: {
        x: {
          type:'logarithmic', min:1, max:100,
          title:{display:true, text:"DUTY CYCLE [%]"},
          ticks: {
            callback: v => (v===1 || v===10 || v===100)?v:'',
            major:{enabled:true}
          },
          grid: {
            color: ctx => (ctx.tick.value===1||ctx.tick.value===10||ctx.tick.value===100) ? '#000' : '#bbb',
            borderDash: ctx => (ctx.tick.value===1||ctx.tick.value===10||ctx.tick.value===100) ? [] : [2,3]
          }
        },
        y: {
          min:0, max:60000,
          title: {display:true, text:"CURRENT (A)"},
          ticks: {
            stepSize:1000,
            callback:v => (v%5000===0)?v:"",
            major:{enabled:true}
          },
          grid: {
            color: ctx => (+ctx.tick.value%5000===0 ? "#000" : "#ccc"),
            lineWidth: ctx => (+ctx.tick.value%5000===0 ? 1.8 : 0.7),
            borderDash: ctx => (+ctx.tick.value%5000===0 ? [] : [3,4])
          }
        }
      },
      animation: {
        onComplete: function() {
          // OK/NG 마크 위치 조정 (반응형)
          const labelDiv = document.getElementById('okng-label');
          labelDiv.style.display='none';
          if(lastECCJudge && chart && specialPoint) {
            const xval=specialPoint.x, yval=specialPoint.y;
            const meta = chart.scales;
            let xp = meta.x.getPixelForValue(xval||1);
            let yp = meta.y.getPixelForValue(yval||0);
            // 화면 좌우 및 상단 최대치 안넘게
            let padR = ctx.canvas.clientWidth - 46;
            let padL = 3;
            xp = Math.min(Math.max(xp-28, padL), padR);
            yp = Math.max(yp-34, 7);
            labelDiv.innerHTML = lastECCJudge.mark;
            labelDiv.style.color = lastECCJudge.color;
            labelDiv.style.left = xp + 'px';
            labelDiv.style.top = yp + 'px';
            labelDiv.style.display = 'block';
          }
        }
      }
    }
  });
}
window.onload = () => { calculateAndDraw(); };
</script>
</body>
</html>

